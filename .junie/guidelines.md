# Flowlet 開発ガイドライン

本ドキュメントは、家計管理アプリ「Flowlet」のバックエンド開発における設計指針とコーディング規約を定めたものです。

## 1. 用語定義（ドメイン）

本プロジェクトで扱う主要な概念と英語表記を定義します。

- **実口座 (Physical Account)**: 銀行、証券、現金など、物理的なお金の場所。
- **仮想口座 (Virtual Account)**: 旅行用、予備費など、ユーザーが設定したお金の使用目的。
- **取引 (Transaction)**: 収支または振替。
- **取引内訳 (TransactionDetail)**: 一つの取引に紐づく複数の明細（スプリット）。
- **資産同期 (Balance Synchronization)**: すべての実口座の残高合計と、すべての仮想口座の残高合計を一致させる管理。

## 2. 設計原則 (DDD)

本プロジェクトはドメイン駆動設計（DDD）の考え方をベースに構築します。

- **ドメイン中心**: DB設計からではなく、業務上の概念（ユビキタス言語）からモデルを設計する。
- **計算ロジックの所在**: 
  - 単一のエンティティで完結する計算はエンティティ内に記述。
  - 実口座と仮想口座の同期チェックや、年間支出の平準化ロジックなど、複数のエンティティが関わる複雑なロジックは **Domain Service** に配置する。
- **カプセル化**: 不正な状態のオブジェクトが生成されないよう、ガード節によるバリデーションを徹底する。

## 3. アーキテクチャ構成

以下の4層レイヤーを採用しています。

- **Presentation (`presentation`)**: `Controller`, `GlobalExceptionHandler`
  - 外部とのインターフェース。HTTPリクエストの受付とレスポンス変換。
- **Application (`application`)**: `ApplicationService`, `DTO`
  - ユースケースの実現。トランザクション境界の管理。
- **Domain (`domain`)**: `Model (Entity/VO)`, `Repository Interface`, `DomainService`
  - 業務ロジックの核。外部ライブラリへの依存を最小限にする。
- **Infrastructure**: `Repository Implementation`, `Config`
  - DBアクセスや外部通信の具体的な実装。

## 4. コーディング規約

### 4.1. Java 言語活用
- **Java 25**: 最新の機能（プロジェクト・パナマ、構造化並列処理など）の利用も視野に入れつつ、型安全な開発を行う。
- **Value Object**: 原則として Java `record` を使用する。
- **不変性 (Immutability)**: 可能な限りオブジェクトは不変として扱う。
- **型宣言**: 型推論（`var`）を積極的に活用し、コードの冗長性を排除する。
- **制御構文**: 可読性向上のため、`if` 文などの制御構文では常に波括弧 `{}` を使用する。

### 4.2. 命名規則
- **Entity**: プレフィックス（M/T等）は使用せず、ドメイン概念をそのままクラス名とする（例: `PhysicalAccount`, `Transaction`）。
- **パッケージ構造**: `com.example.flowlet.[layer].[subdomain]` の形式に従う。

### 4.3. バリデーションとエラーハンドリング
- **入力チェック**: DTOで `jakarta.validation` アノテーションを使用。
- **業務ルール**: Entity/Value Object のコンストラクタでチェックを行い、不正な場合は適切なカスタム例外または `IllegalArgumentException` をスローする。
- **エラーメッセージ**: メッセージ定義（MessageSource等）で一元管理する。

### 4.4. テスト方針
- **ドメインロジック**: 複雑な計算（同期、平準化、予算対比）については、JUnit 5を用いて徹底的にユニットテストを行う。
- **正常・異常系**: 境界値テストを含め、業務上の制約が守られていることをテストで担保する。

## 5. 技術スタックの利用

- **Spring Boot 4.0 / Spring Data JPA**: 最新のSpringエコシステムを活用。
- **Lombok**: Entity の Getter/Setter 等、ボイラープレートコードの削減に使用。Value Object (`record`) には使用しない。
- **PostgreSQL**: 永続化データベース。

## 6. ドキュメント・Git 運用

- **Decision Log**: 設計判断（なぜその実装にしたか）は `README.md` に記録する。
- **Git**: 「1つの関心事につき1コミット」を徹底する。